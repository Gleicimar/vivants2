{% extends "base.html" %}

{% block title %}{{ produto.nome }} - Vivants{% endblock %}

{% block content %}
<div class="container my-5">
    <nav class="mb-4">
        <a href="{{ url_for('produtos_lista') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar aos Produtos
        </a>
    </nav>

    <div class="row">
        <div class="col-md-6 text-center">
            <div class="product-image-container mb-4">
                {% if produto.imagem %}
                    <img src="{{ produto.imagem }}" alt="{{ produto.nome }}" class="img-fluid rounded" style="max-height: 400px;">
                {% else %}
                    <i class="bi bi-stars product-image text-primary"></i>
                {% endif %}
            </div>
        </div>
        <div class="col-md-6">
            <span class="badge bg-primary mb-2">{{ produto.categoria_nome }}</span>
            <h1 class="mb-3">{{ produto.nome }}</h1>
            <p class="lead text-muted">{{ produto.descricao }}</p>

            <div class="pricing-section my-4 p-3 bg-light rounded">
                {% if produto.preco_promocional %}
                    <div class="d-flex align-items-center mb-2">
                        <span class="h4 text-decoration-line-through text-muted me-3">R$ {{ "%.2f"|format(produto.preco) }}</span>
                        <span class="h2 text-success">R$ {{ "%.2f"|format(produto.preco_promocional) }}</span>
                    </div>
                    <span class="badge bg-danger">Economize R$ {{ "%.2f"|format(produto.preco - produto.preco_promocional) }}</span>
                {% else %}
                    <span class="h2">R$ {{ "%.2f"|format(produto.preco) }}</span>
                {% endif %}
            </div>

            <div class="stock-info mb-4">
                <p class="mb-1">
                    <strong>Estoque:</strong>
                    {% if produto.estoque > 10 %}
                        <span class="text-success">{{ produto.estoque }} unidades disponíveis</span>
                    {% elif produto.estoque > 0 %}
                        <span class="text-warning">Apenas {{ produto.estoque }} unidades restantes</span>
                    {% else %}
                        <span class="text-danger">Produto esgotado</span>
                    {% endif %}
                </p>
            </div>

            {% if session.user_id %}
                {% if produto.estoque > 0 %}
                    <form method="POST" action="{{ url_for('adicionar_carrinho', produto_id=produto.id) }}">
                        <div class="row align-items-center mb-4">
                            <div class="col-auto">
                                <label class="form-label"><strong>Quantidade:</strong></label>
                            </div>
                            <div class="col-auto">
                                <div class="input-group" style="width: 140px;">
                                    <button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity()">-</button>
                                    <input type="number" name="quantidade" id="quantidade" class="form-control text-center" value="1" min="1" max="{{ produto.estoque }}">
                                    <button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity()">+</button>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-vivants btn-lg w-100 py-3">
                            <i class="bi bi-cart-plus"></i> Adicionar ao Carrinho
                        </button>
                    </form>
                {% else %}
                    <button class="btn btn-secondary btn-lg w-100 py-3" disabled>
                        <i class="bi bi-x-circle"></i> Produto Esgotado
                    </button>
                {% endif %}
            {% else %}
                <div class="text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-vivants btn-lg px-5">
                        <i class="bi bi-box-arrow-in-right"></i> Faça login para comprar
                    </a>
                    <p class="text-muted mt-2">Ou <a href="{{ url_for('cadastro') }}">crie uma conta</a> para fazer pedidos</p>
                </div>
            {% endif %}

            <!-- Informações adicionais -->
            <div class="product-features mt-5">
                <h5 class="mb-3">Características do Produto</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-truck text-primary me-2"></i>
                            <small>Entrega em todo Brasil</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-shield-check text-primary me-2"></i>
                            <small>Compra 100% segura</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-arrow-left-right text-primary me-2"></i>
                            <small>Troca garantida</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-award text-primary me-2"></i>
                            <small>Produto original</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Avaliações -->
    <hr class="my-5">

    <div class="row">
        <div class="col-md-8">
            <h3 class="mb-4">
                <i class="bi bi-star-fill text-warning"></i>
                Avaliações do Produto
                {% if avaliacoes %}
                    <span class="badge bg-primary ms-2">{{ avaliacoes|length }} avaliação{{ 's' if avaliacoes|length > 1 else '' }}</span>
                {% endif %}
            </h3>

            {% if avaliacoes %}
                {% for avaliacao in avaliacoes %}
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">{{ avaliacao.usuario_nome }}</h6>
                                    <div class="mb-2">
                                        {% for i in range(5) %}
                                            {% if i < avaliacao.nota %}
                                                <i class="bi bi-star-fill text-warning"></i>
                                            {% else %}
                                                <i class="bi bi-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">{{ avaliacao.data_avaliacao }}</small>
                            </div>
                            {% if avaliacao.comentario %}
                                <p class="mb-0">{{ avaliacao.comentario }}</p>
                            {% else %}
                                <p class="text-muted mb-0"><em>Sem comentário</em></p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-chat-square-text display-4 text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma avaliação ainda</h5>
                    <p class="text-muted">Seja o primeiro a avaliar este produto!</p>
                </div>
            {% endif %}

            <!-- Formulário de avaliação (apenas para usuários logados) -->
            {% if session.user_id %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Deixe sua avaliação</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('avaliar_produto', id=produto.id) }}">
                            <div class="mb-3">
                                <label class="form-label">Sua nota</label>
                                <div class="rating-stars">
                                    {% for i in range(5, 0, -1) %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="nota" id="nota{{ i }}" value="{{ i }}" required>
                                            <label class="form-check-label" for="nota{{ i }}">
                                                {% for j in range(i) %}
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                {% endfor %}
                                                {% for j in range(5 - i) %}
                                                    <i class="bi bi-star text-warning"></i>
                                                {% endfor %}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Comentário (opcional)</label>
                                <textarea name="comentario" class="form-control" rows="3" placeholder="Compartilhe sua experiência com este produto..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-vivants">Enviar Avaliação</button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <a href="{{ url_for('login') }}" class="alert-link">Faça login</a> para deixar uma avaliação deste produto.
                </div>
            {% endif %}
        </div>

        <!-- Produtos relacionados -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Produtos Relacionados</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for rel in produtos_relacionados %}
                        <a href="{{ url_for('produto_detalhe', id=rel.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-stars text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-1">{{ rel.nome }}</h6>
                                    <small class="text-muted">R$ {{ "%.2f"|format(rel.preco_promocional or rel.preco) }}</small>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.product-image-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 2rem;
}

.pricing-section {
    border-left: 4px solid var(--primary);
}

.rating-stars .form-check-input {
    display: none;
}

.rating-stars .form-check-label {
    cursor: pointer;
    padding: 5px;
}

.rating-stars .form-check-input:checked + .form-check-label {
    background-color: rgba(255, 193, 7, 0.1);
    border-radius: 5px;
}
</style>

<script>
function incrementQuantity() {
    const input = document.getElementById('quantidade');
    const max = parseInt(input.getAttribute('max'));
    if (parseInt(input.value) < max) {
        input.value = parseInt(input.value) + 1;
    }
}

function decrementQuantity() {
    const input = document.getElementById('quantidade');
    if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
    }
}

// Validação em tempo real da quantidade
document.addEventListener('DOMContentLoaded', function() {
    const quantidadeInput = document.getElementById('quantidade');
    if (quantidadeInput) {
        quantidadeInput.addEventListener('change', function() {
            const max = parseInt(this.getAttribute('max'));
            const value = parseInt(this.value);

            if (value < 1) {
                this.value = 1;
            } else if (value > max) {
                this.value = max;
            }
        });
    }
});
</script>
{% endblock %}
